<!DOCTYPE html><html><head><meta charset="utf-8"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="yes" name="apple-touch-fullscreen"><meta content="telephone=no,email=no" name="format-detection"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet"><script src="https://use.fontawesome.com/adaf0e149c.js"></script><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/monokai_sublime.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="/css/markdown-github.css"><title>林水溶的博客</title><script src="/js/googleAnalytics.js"></script></head><body><div id="postContainer"><div id="postTop"><h4 id="logo">Life Is Short</h4><br><br><h2 id="postTitle">Vue SPA(单页应用)首屏优化实践</h2><br><span aria-hidden="true" class="postTime fa fa-calendar">2017-5-7</span><span aria-hidden="true" class="postTags fa fa-tags">&nbsp;Vue</span><span aria-hidden="true" class="postTags fa fa-tags">&nbsp;性能优化</span><span aria-hidden="true" class="postTags fa fa-tags">&nbsp;SPA</span><br><br></div><section id="articleDiv"><h4 id="1-代码压缩-gzip"><a href="#1-代码压缩-gzip" class="headerlink" title="1.代码压缩(gzip)"></a>1.代码压缩(gzip)</h4><p>如果你用的是<code>nginx</code>服务器，请修改配置文件(其他web server 类似)：</p><br><p><code>sudo nano /etc/nginx/nginx.conf</code></p><br><p>在Gzip Settings里加入：</p><br><pre><code class="shell">gzip on;<br>gzip_min_length 1k;<br>gzip_buffers 4 16k;<br>gzip_comp_level 5;<br>gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php;<br></code></pre><br><ul><br><li>gzip<ul><br><li>开启或者关闭 gzip 模块，这里使用 on 表示启动</li><br></ul><br></li><br><li>gzip_min_length<ul><br><li>设置允许压缩的页面最小字节数．默认值是0，不管页面多大都压缩．</li><br></ul><br></li><br><li>gzip_buffers<ul><br><li>设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流．4 16k 代表以 16k 为单位，按照原始数据大小以 16k 为单位的4倍申请内存</li><br></ul><br></li><br><li>gzip_comp_level<ul><br><li>压缩比，压缩比１最小处理速度最快，压缩比9最大但处理最慢（传输快但比较消耗cpu）</li><br></ul><br></li><br><li>gzip_types<ul><br><li>匹配MIME类型进行压缩，（无论是否指定）”text/html” 类型总是会被压缩</li><br></ul><br></li><br></ul><br><blockquote><br><p>我这样配置，把首页一个需要下载的文件由716KB压缩到了246KB．优化比66%．</p><br></blockquote><br><p><strong>如果你没有开启服务器端的gzip，也可以开启前后端代码的压缩</strong></p><br><p>如果你后端用的是Express.js框架来提供Web服务，那么可以使用压缩中间件进行<a href="https://expressjs.com/zh-cn/advanced/best-practice-performance.html" target="_blank" rel="external">gzip压缩</a>．</p><br><pre><code class="javascript">var compression = require(&#39;compression&#39;);<br>var express = require(&#39;express&#39;);<br>var app = express();<br>app.use(compression());<br></code></pre><br><p>如果你前端是用<code>vue-cli</code>生成的项目，那么在Webpack配置文件（生产环境）中已经开启了代码的压缩．</p><br><h4 id="２-外部文件按需引入-不用外部文件，自己造轮子"><a href="#２-外部文件按需引入-不用外部文件，自己造轮子" class="headerlink" title="２. 外部文件按需引入||不用外部文件，自己造轮子"></a>２. 外部文件按需引入||不用外部文件，自己造轮子</h4><p><strong>在项目中使用<code>Element</code>的话，按需引入：</strong></p><br><p>首先安装 <a href="https://github.com/QingWei-Li/babel-plugin-component" target="_blank" rel="external">babel-plugin-component</a>：</p><br><p><code>npm install babel-plugin-component -D</code></p><br><p>它让我们可以只引入需要的组件，以达到减小项目体积的目的.</p><br><p>PS: 如果这时报错：</p><br><pre><code class="shell">Error: post install error, please remove node_modules before retry<br></code></pre><br><p>这是<code>cnpm</code>的锅．原因不详．解决办法是换用npm安装此模块．(我试过移除node_modules文件，报错依旧)</p><br><p><strong>如果你用了Ajax相关的库，比如vue-resource/axios的话</strong></p><br><p>去掉它，自己实现一个Ajax库吧．</p><br><p>比如我的项目中只涉及了<code>get</code>,<code>post</code>，那么vue-resource/axios对我来说就很没必要了．</p><br><p>所以我就封装个库（支持Promise,不支持IE）在Vue中当作插件使用：</p><br><pre><code class="javascript">/<em> xhr.js </em>/<br>class XHR {<br>    get(url) {<br>        return new Promise((resolve, reject) =&gt; {<br>            const xhr = new XMLHttpRequest();<br>            xhr.onreadystatechange = () =&gt; {<br>                if (xhr.readyState === 4) {<br>                    if (xhr.status &gt;= 200 &amp;&amp; (xhr.status &lt; 300 || xhr.status === 304)) {<br>                        if (xhr.responseText) {<br>                            resolve(JSON.parse(xhr.responseText));<br>                        } else {<br>                            resolve(xhr.responseText);<br>                        }<br>                    } else {<br>                        reject(<code>XHR unsuccessful:${xhr.status}</code>);<br>                    }<br>                }<br>            };<br>            xhr.open(&#39;get&#39;, url, true);<br>            xhr.setRequestHeader(&#39;content-type&#39;, &#39;application/json&#39;);<br>            xhr.send(null);<br>        });<br>    }<br><br>    post(url, data) {<br>        return new Promise((resolve, reject) =&gt; {<br>            const xhr = new XMLHttpRequest();<br>            xhr.onreadystatechange = () =&gt; {<br>                if (xhr.readyState === 4) {<br>                    if (xhr.status &gt;= 200 &amp;&amp; (xhr.status &lt; 300 || xhr.status === 304)) {<br>                        resolve(JSON.parse(xhr.responseText));<br>                    } else {<br>                        reject(<code>XHR unsuccessful:${xhr.status}</code>);<br>                    }<br>                }<br>            };<br>            xhr.open(&#39;post&#39;, url, true);<br>            xhr.setRequestHeader(&#39;content-type&#39;, &#39;application/json&#39;);<br>            xhr.send(JSON.stringify(data));<br>        });<br>    }<br>}<br><br>/<em> Vue插件要求提供install方法：<a href="https://cn.vuejs.org/v2/guide/plugins.html">https://cn.vuejs.org/v2/guide/plugins.html</a> </em>/<br>XHR.install = (Vue) =&gt; {<br>    Vue.prototype.$get = new XHR().get;<br>    Vue.prototype.$post = new XHR().post;<br>};<br><br>export default XHR;<br></code></pre><br><blockquote><br><p>这种方法一般能缩小文件几十KB．比如vue-resource有35KB,我的这个xhr.js只有1.9KB．</p><br></blockquote><br><h4 id="3．代码分块-Code-Splitting"><a href="#3．代码分块-Code-Splitting" class="headerlink" title="3．代码分块/Code Splitting"></a>3．代码分块/Code Splitting</h4><p>顾名思义，就是讲代码分成块，按需加载．这样，如果首屏不需要的块，就不用加载了．</p><br><p>对于大型项目可能更有用，因为在我的这个项目中首页需要的文件和其他页面需要的基本一样，所以代码分块对我这个项目而言，就没必要了．</p><br><h4 id="4-路由组件懒加载"><a href="#4-路由组件懒加载" class="headerlink" title="4. 路由组件懒加载"></a>4. 路由组件懒加载</h4><p>当打包构建应用时，Javascript 包会变得非常大，影响页面加载。如果我们能把不同路由对应的组件分割成不同的代码块，然后当路由被访问的时候才加载对应组件，这样就更加高效了</p><br><p>结合 Vue 的 <a href="http://vuejs.org/guide/components.html#Async-Components" target="_blank" rel="external">异步组件</a> 和 Webpack 的 <a href="https://webpack.js.org/guides/code-splitting-require/" target="_blank" rel="external">code splitting feature</a>,可以轻松实现路由组件的懒加载．</p><br><p>我们要做的就是把路由对应的组件定义成异步组件：</p><br><pre><code class="javascript">const Foo = resolve =&gt; {<br>  /<em> require.ensure 是 Webpack 的特殊语法，用来设置 code-split point<br>  （代码分块）</em>/<br>  require.ensure([&#39;./Foo.vue&#39;], () =&gt; {<br>    resolve(require(&#39;./Foo.vue&#39;))<br>  })<br>}<br>/<em> 另一种写法 </em>/<br>const Foo = resolve =&gt; require([&#39;./Foo.vue&#39;], resolve);<br></code></pre><br><p>不需要改变任何路由配置，跟之前一样使用 <code>Foo</code>：</p><br><pre><code class="javascript">const router = new VueRouter({<br>  routes: [<br>    { path: &#39;/foo&#39;, component: Foo }<br>  ]<br>})<br></code></pre><br><h4 id="4-Webpack2-Tree-shaking"><a href="#4-Webpack2-Tree-shaking" class="headerlink" title="4. Webpack2 Tree-shaking"></a>4. Webpack2 Tree-shaking</h4><p><code>Tree-shaking</code> 用来消除没有用到的代码．</p><br><blockquote><br><p>个人小项目一般用不到tree-shaking．因为你不会写没用到的代码．规模很大的项目或许可以尝试使用它．</p><br></blockquote><br><h4 id="5-减少XHR中不必要的数据．"><a href="#5-减少XHR中不必要的数据．" class="headerlink" title="5. 减少XHR中不必要的数据．"></a>5. 减少XHR中不必要的数据．</h4><p>比如我的项目中，首页只需要博客Title,id和Tags．Time和Content不需要了，况且Content一般还很大(一般一篇10KB左右)．</p><br><h4 id="6-SSR-Server-Side-Render-服务端渲染"><a href="#6-SSR-Server-Side-Render-服务端渲染" class="headerlink" title="6. SSR(Server Side Render/服务端渲染)"></a>6. SSR(Server Side Render/服务端渲染)</h4><p>这个有点难搞．但效果貌似挺不错．我之前在<a href="https://cn.vuejs.org/v2/guide/ssr.html" target="_blank" rel="external">Vue文档中</a>简单看了一边，打算以后有需求了再搞不迟．</p><br><h4 id="7-其他诸如图片懒加载就不赘述了，前端开发者应该有的常识．"><a href="#7-其他诸如图片懒加载就不赘述了，前端开发者应该有的常识．" class="headerlink" title="7. 其他诸如图片懒加载就不赘述了，前端开发者应该有的常识．"></a>7. 其他诸如图片懒加载就不赘述了，前端开发者应该有的常识．</h4></section></div><script src="/js/jquery.min.js"></script><script src="/js/highlight.min.js"></script><script src="/js/start.js"></script></body></html>